<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>APC Journals List</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <link href="https://cdn.datatables.net/v/dt/jq-3.7.0/dt-2.3.2/datatables.min.css" rel="stylesheet"
    integrity="sha384-dG72sN6C6+JA9moN/5eRa0GqXlYOpTivxgRRV4rTctUeb4ZNF6uuJ5NXmz+8+3Qi" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/@umich-lib/web@latest/umich-lib.css" rel="stylesheet" />
  <style>
    #apcTable th:nth-child(7),
    #apcTable td:nth-child(7) {
      width: 150px !important;
      max-width: 150px !important;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .dt-length > label {
      margin-left: 10px;
    }
    
    #publisherFilters {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 5px;
    }
    
    .publisher-checkbox {
      margin-bottom: 5px;
    }
    
    .publisher-checkbox label {
      font-weight: normal;
      margin-left: 5px;
    }
  </style>
</head>

<body>
  <m-universal-header></m-universal-header>
  <div>
    <m-website-header name="APC Journals" variant="dark">
    </m-website-header>
  </div>
  <div class="container mt-5">
    <h1 class="mb-4">APC Journals</h1>
    <p>This table lists journals with Article Processing Charges (APCs) that are supported by the University of Michigan
      Library.</p>
    
    <!-- Publisher Filter -->
    <div class="mb-4">
      <h5>Filter by Publisher:</h5>
      <div id="publisherFilters" class="row">
        <!-- Checkboxes will be populated here -->
      </div>
      <button id="clearFilters" class="btn btn-secondary btn-sm mt-2">Clear All Filters</button>
    </div>
    
    <table id="apcTable" class="m-table m-table--responsive-small"></table>
  </div>
  <script type="module"
    src="https://cdn.jsdelivr.net/npm/@umich-lib/web@latest/dist/umich-lib/umich-lib.esm.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"
    integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
    crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/v/dt/jq-3.7.0/dt-2.3.2/datatables.min.js"
    integrity="sha384-qLLX0jMaWXMZrun5/ry13tv5MX78CJNleGaaJVXRuJCDiAwyjhYWsTM3Qk3VaKC3"
    crossorigin="anonymous"></script>
  <script type="text/javascript">
    $(document).ready(function () {
      var header = ["Journal Title", "eISSN", "Publisher", "Amount Funded", "Campuses Covered", "Coverage Years", "Link to Agreement"];
      var columns = [
        { title: "Journal Title", data: 1 },  
        { title: "eISSN", data: 2 },
        { title: "Publisher", data: 0 },
        { title: "Amount Funded", data: 3 },
        { title: "Campuses Covered", data: 4 },
        { title: "Coverage Years", data: 6 },
        { title: "Link to Agreement", data: 5 }
      ];
      
      var table = $('#apcTable').DataTable({
        ajax: {
          url: "data.json",
          dataSrc: function(json) {
            // Populate publisher checkboxes after data is loaded
            populatePublisherFilters(json.data);
            return json.data;
          }
        },
        columns: columns,
        pageLength: 5,
        lengthMenu: [5, 10, 25, 50],
        order: [[1, 'asc']],
        autoWidth: false,
        language: {
          search: "Search by Journal Title or eISSN:"
        },
        columnDefs: [
          {
            "targets": [2, 3, 4, 5, 6], // search only against journal title and eISSN
            "searchable": false
          },
          {
            "targets": 6,
            "width": "150px",
            "render": function (data, type, row) {
              if (type === 'display' && data) {
                return '<a href="' + data + '" target="_blank">' + data + '</a>';
              }
              return data;
            }
          }
        ]
      });

      // Function to populate publisher filter checkboxes
      function populatePublisherFilters(data) {
        var publishers = [];
        
        // Extract unique publishers
        data.forEach(function(row) {
          var publisher = row[0]; // Publisher is at index 0 in the data
          if (publisher && publishers.indexOf(publisher) === -1) {
            publishers.push(publisher);
          }
        });
        
        publishers.sort();
        
        var filtersHtml = '';
        publishers.forEach(function(publisher, index) {
          filtersHtml += '<div class="col-md-4 col-sm-6 publisher-checkbox">';
          filtersHtml += '<input type="checkbox" id="pub_' + index + '" value="' + publisher + '" checked>';
          filtersHtml += '<label for="pub_' + index + '">' + publisher + '</label>';
          filtersHtml += '</div>';
        });
        
        $('#publisherFilters').html(filtersHtml);
        
        $('#publisherFilters input[type="checkbox"]').on('change', function() {
          filterTable();
        });
      }

      function filterTable() {
        var selectedPublishers = [];
        $('#publisherFilters input[type="checkbox"]:checked').each(function() {
          selectedPublishers.push($(this).val());
        });
        
        // tap into DT search
        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
          if (settings.nTable.id !== 'apcTable') {
            return true;
          }
          
          var publisher = data[2]; // Publisher column is at display index 2
          
          if (selectedPublishers.length === 0) {
            return false; // No publishers selected
          }
          
          return selectedPublishers.indexOf(publisher) !== -1;
        });
        
        table.draw();
        
        // Remove the custom search function to avoid conflicts
        $.fn.dataTable.ext.search.pop();
      }

      // Clear all filters button
      $('#clearFilters').on('click', function() {
        $('#publisherFilters input[type="checkbox"]').prop('checked', true);
        filterTable();
      });
    });
  </script>
</body>

</html>