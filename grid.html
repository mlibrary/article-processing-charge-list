<!doctype html>
<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Journals with APC Discounts or Waivers</title>
  <script type="text/javascript" src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css">
  <link href="https://cdn.jsdelivr.net/npm/@umich-lib/web@latest/umich-lib.css" rel="stylesheet" />
  <style>
    .campus-dropdown-btn {
      margin-right: 1em;
      padding: 0.5em 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      background-image: var(--icon-arrow-down);
      background-repeat: no-repeat;
      background-position: right 0.75em center;
      padding-right: 2.5em;
      display: inline-block;
      font: inherit;
    }
    :root {
      --icon-arrow-down: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M480-345 240-585l56-56 184 184 184-184 56 56-240 240Z"/></svg>');
    }

    .gridjs-input {
      width: 400px !important;
    }

    h1 {
      font-weight: 300;
    }

    .gridjs-th,
    .gridjs-td,
    .gridjs-tr,
    .gridjs-thead,
    .gridjs-tbody,
    td.gridjs-td,
    .gridjs-tr {
      background: none;
      background-color: none;
      color: inherit;
      border: none;
      border-bottom: none;
      padding: none;
    }
  </style>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
      var header = ["Journal Title", "eISSN", "Publisher", "Amount Funded", "Campuses Covered", "Coverage Years", "Link to Agreement"];
      function rearrangeRow(row) {
        return [
          row[1],
          row[2],
          row[0],
          row[3],
          row[4],
          row[6],
          row[5]
        ];
      }

      let allRows = [];
      let filteredRows = [];
      let grid;

      function getUniqueCampuses(rows) {
        const campuses = new Set();
        rows.forEach(row => {
          if (row[4]) {
            campuses.add(row[4].trim());
          }
        });
        return Array.from(campuses).sort();
      }

      function renderCampusFilter(campuses) {
        let filterDiv = document.getElementById('campus-filter');
        if (!filterDiv) {
          filterDiv = document.createElement('div');
          filterDiv.id = 'campus-filter';
          filterDiv.style.marginBottom = '1em';
          const container = document.querySelector('.viewport-container');
          container.insertBefore(filterDiv, document.getElementById('table'));
        }
        filterDiv.innerHTML = '';
        // Dropdown button
          const dropdownBtn = document.createElement('button');
          dropdownBtn.type = 'button';
          dropdownBtn.textContent = 'Filter by Campuses';
          dropdownBtn.className = 'campus-dropdown-btn';
        filterDiv.appendChild(dropdownBtn);

        // Dropdown content
        const dropdownContent = document.createElement('div');
        dropdownContent.style.display = 'none';
        dropdownContent.style.position = 'absolute';
        dropdownContent.style.background = '#fff';
        dropdownContent.style.border = '1px solid #ccc';
        dropdownContent.style.padding = '0.5em 1em';
        dropdownContent.style.zIndex = '1000';
        dropdownContent.style.maxHeight = '300px';
        dropdownContent.style.overflowY = 'auto';
        dropdownContent.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
        dropdownContent.style.minWidth = '200px';

        // Global select/deselect all
        const globalLabel = document.createElement('label');
        globalLabel.style.display = 'block';
        globalLabel.style.marginBottom = '0.5em';
        globalLabel.style.fontWeight = 'bold';
        const globalCheckbox = document.createElement('input');
        globalCheckbox.type = 'checkbox';
        globalCheckbox.id = 'campus_all';
        globalCheckbox.checked = true;
        globalLabel.appendChild(globalCheckbox);
        globalLabel.appendChild(document.createTextNode(' Select/Deselect All'));
        dropdownContent.appendChild(globalLabel);

        // Individual campus checkboxes
        campuses.forEach(campus => {
          const id = 'campus_' + campus.replace(/\W/g, '_');
          const label = document.createElement('label');
          label.style.display = 'block';
          label.style.marginBottom = '0.25em';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = campus;
          checkbox.id = id;
          checkbox.checked = true;
          checkbox.className = 'campus-checkbox';
          checkbox.addEventListener('change', function () {
            // If any are unchecked, uncheck global; if all checked, check global
            const allBoxes = dropdownContent.querySelectorAll('.campus-checkbox');
            const checkedCount = Array.from(allBoxes).filter(cb => cb.checked).length;
            globalCheckbox.checked = checkedCount === allBoxes.length;
            applyCampusFilter();
          });
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(' ' + campus));
          dropdownContent.appendChild(label);
        });

        // Global checkbox logic
        globalCheckbox.addEventListener('change', function () {
          const allBoxes = dropdownContent.querySelectorAll('.campus-checkbox');
          allBoxes.forEach(cb => { cb.checked = globalCheckbox.checked; });
          applyCampusFilter();
        });
        filterDiv.appendChild(dropdownContent);

        // Show/hide dropdown on button click
        dropdownBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          dropdownContent.style.display = dropdownContent.style.display === 'none' ? 'block' : 'none';
        });
        // Hide dropdown when clicking outside
        document.addEventListener('click', function (e) {
          if (!filterDiv.contains(e.target)) {
            dropdownContent.style.display = 'none';
          }
        });
      }

      function applyCampusFilter() {
        const checked = Array.from(document.querySelectorAll('#campus-filter input[type=checkbox]:checked')).map(cb => cb.value);
        filteredRows = allRows.filter(row => {
          if (!row[4]) return false;
          return checked.includes(row[4].trim());
        });
        grid.updateConfig({
          data: filteredRows
        }).forceRender();
      }

      fetch('data.json')
        .then(resp => resp.json())
        .then(data => {
          allRows = data.data.map(rearrangeRow);
          filteredRows = allRows.slice();
          const campuses = getUniqueCampuses(allRows);
          renderCampusFilter(campuses);
          grid = new gridjs.Grid({
            className: {
              table: "m-table m-table--responsive-small",
              th: "clear",
              td: "clear",
              tr: "clear"
            },
            columns: header,
            data: filteredRows,
            pagination: { limit: 5 },
            search: {
              enabled: true,
              selector: (cell, rowIndex, cellIndex) => {
                if (cellIndex === 0 || cellIndex === 1) {
                  return cell;
                }
              },
            },
            language: {
              search: {
                placeholder: 'Search Journal Title or eISSN (i.e., 0010-0285)'
              }
            },
            sort: true
          }).render(document.getElementById("table"));
              // Add results summary at the top
              const summaryDiv = document.createElement('div');
              summaryDiv.id = 'results-summary-top';
              summaryDiv.style.marginBottom = '0.5em';
              summaryDiv.style.fontSize = '0.95em';
              summaryDiv.style.color = '#444';
              document.querySelector('.viewport-container').insertBefore(summaryDiv, document.getElementById('table'));
    
              function updateResultsSummary() {
                console.log("hit");
                const state = grid.config.pagination;
                let total = filteredRows.length;
                let page = state && state.page ? state.page : 1;
                let limit = state && state.limit ? state.limit : 5;
                let start = total === 0 ? 0 : (page - 1) * limit + 1;
                let end = Math.min(page * limit, total);
                summaryDiv.textContent = `Showing ${start} to ${end} of ${total} results`;
              }
    
              updateResultsSummary();
    
              grid.on('paginationChanged', updateResultsSummary);
              grid.on('dataChanged', updateResultsSummary);
    
              const origApplyCampusFilter = applyCampusFilter;
              applyCampusFilter = function() {
                origApplyCampusFilter();
                updateResultsSummary();
              };
        });
    });
  </script>
</head>

<body>
  <m-universal-header></m-universal-header>
  <div>
    <m-website-header name="APC Journals" variant="dark">
    </m-website-header>
  </div>
  <main>
    <div class="viewport-container">
      <h1>Journals with APC Discounts or Waivers</h1>
      <p style="max-width:38rem;">Search this list to determine if a journal is covered by an Article
        Processing Charge (APC) agreement, and if so, how much funding is available when the corresponding author is
        affiliated with the University of Michigan. We recommend corresponding authors use their UMich email address to
        avoid delays in the verification process. Email <a href="mailto:lib-oa-pub@umich.edu">lib-oa-pub@umich.edu</a>
        with questions</p>

      <div id="campus-filter" style="margin-bottom:1em;"></div>
      <table id="table"></table>
    </div>
  </main>
</body>
<script type="module" src="https://cdn.jsdelivr.net/npm/@umich-lib/web@latest/dist/umich-lib/umich-lib.esm.js"></script>

</html>